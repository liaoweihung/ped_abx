<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>克流感專用速算器</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#3498db">
    <link rel="apple-touch-icon" href="icon.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <style>
        body { font-family: "Microsoft JhengHei", Arial, sans-serif; background-color: #f4f6f9; margin: 0; padding: 0; color: #333; }
        .container { max-width: 600px; margin: 0 auto; background: white; min-height: 100vh; display: flex; flex-direction: column; }
        
        header { background-color: #3498db; color: white; padding: 15px; text-align: center; }
        header h2 { margin: 0; font-size: 20px; display: flex; align-items: center; justify-content: center; gap: 10px; }

        .content { padding: 20px; flex: 1; }

        .tab-group { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab-btn { 
            flex: 1; padding: 12px; border: 2px solid #3498db; background: white; color: #3498db; 
            font-size: 16px; font-weight: bold; border-radius: 8px; cursor: pointer; transition: 0.2s;
        }
        .tab-btn.active { background: #3498db; color: white; }

        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 16px; }
        input[type="number"] { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 18px; box-sizing: border-box; }

        .result-card { 
            background-color: #e8f6f3; border: 2px solid #1abc9c; border-radius: 8px; 
            padding: 20px; text-align: center; margin-bottom: 20px; display: none; 
        }
        .result-main { font-size: 18px; line-height: 1.6; color: #2c3e50; }
        .capsule-count { font-size: 36px; font-weight: bold; color: #e74c3c; display: block; margin: 10px 0; }
        .instruction { font-size: 14px; color: #555; background: #fff; padding: 8px; border-radius: 4px; display: inline-block; margin-top: 10px;}
        
        .warning-text { color: #c0392b; font-weight: bold; font-size: 24px; display: block; margin: 10px 0; }

        /* 表格樣式優化 */
        .info-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 15px; }
        .info-table th, .info-table td { border: 1px solid #bdc3c7; padding: 10px; text-align: left; vertical-align: middle; }
        .info-table th { background-color: #ecf0f1; text-align: center; font-weight: bold; color: #2c3e50; }
        .info-table tr:nth-child(even) { background-color: #f8f9fa; }
        .info-table td small { display: block; color: #7f8c8d; margin-top: 4px; font-size: 13px; }

        .renal-section { margin-top: 30px; border-top: 4px solid #95a5a6; padding-top: 20px; }
        .renal-title { font-size: 18px; font-weight: bold; color: #7f8c8d; margin-bottom: 15px; padding-left: 5px; border-left: 4px solid #7f8c8d; }
        
        footer { text-align: center; padding: 15px; background: #eee; font-size: 12px; color: #777; margin-top: auto; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h2>
            <img src="icon.png" style="width: 30px; height: 30px; border-radius: 50%;" onerror="this.style.display='none'">
            克流感調配速算
        </h2>
    </header>

    <div class="content">
        <div class="tab-group">
            <button class="tab-btn" onclick="switchTab('infant')">一歲以下</button>
            <button class="tab-btn active" onclick="switchTab('child')">一歲以上</button>
        </div>

        <div class="input-group">
            <label for="weight">請輸入體重 (kg)</label>
            <input type="number" id="weight" placeholder="例如: 15" step="0.1" oninput="calculate()">
        </div>

        <div id="result-box" class="result-card">
            <div class="result-main" id="result-content"></div>
            <div id="age-note" style="margin-top: 15px; font-size: 14px; color: #e67e22; font-weight: bold;"></div>
        </div>

        <div id="child-table-area" style="display: block;">
            <div style="font-weight: bold; margin-bottom: 5px; color: #34495e;">一歲以上體重對照表 (CDC/WHO)</div>
            <table class="info-table">
                <thead>
                    <tr>
                        <th style="width: 35%">體重</th>
                        <th>建議劑量 (共五天)</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td>≤ 15 kg</td><td>30 mg，每天 2 次</td></tr>
                    <tr><td>> 15 - 23 kg</td><td>45 mg，每天 2 次</td></tr>
                    <tr><td>> 23 - 40 kg</td><td>60 mg，每天 2 次</td></tr>
                    <tr><td>> 40 kg</td><td>75 mg，每天 2 次</td></tr>
                </tbody>
            </table>
        </div>

        <div class="renal-section">
            <div class="renal-title">腎功能劑量調整指引</div>
            <table class="info-table">
                <thead>
                    <tr>
                        <th style="width: 40%">CrCl / 模式</th>
                        <th>Oseltamivir 建議劑量</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>> 60 mL/min</td>
                        <td>不需調整劑量</td>
                    </tr>
                    <tr>
                        <td>30-60 mL/min</td>
                        <td>30 毫克，每天 2 次<br><small>為期 5 天</small></td>
                    </tr>
                    <tr>
                        <td>10-30 mL/min</td>
                        <td>30 毫克，每天 1 次<br><small>為期 5 天</small></td>
                    </tr>
                    <tr>
                        <td>血液透析</td>
                        <td>每次透析後投予一劑 30 毫克<br><small>臨床判斷有需要，第一劑亦可改於透析前給藥</small></td>
                    </tr>
                    <tr>
                        <td>腹膜透析</td>
                        <td>30 毫克單一劑量</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <footer>
        根據克流感仿單 2016 年 4 月
    </footer>
</div>

<script>
    // 預設模式為 'child' (一歲以上)
    let currentMode = 'child'; 

    function switchTab(mode) {
        currentMode = mode;
        const buttons = document.querySelectorAll('.tab-btn');
        if (mode === 'infant') {
            buttons[0].classList.add('active');
            buttons[1].classList.remove('active');
            document.getElementById('child-table-area').style.display = 'none';
        } else {
            buttons[0].classList.remove('active');
            buttons[1].classList.add('active');
            document.getElementById('child-table-area').style.display = 'block';
        }
        calculate();
    }

    function calculate() {
        const weight = parseFloat(document.getElementById('weight').value);
        const resultBox = document.getElementById('result-box');
        const resultContent = document.getElementById('result-content');
        const noteDisplay = document.getElementById('age-note');

        if (!weight || weight <= 0) {
            resultBox.style.display = 'none';
            return;
        }

        const standardTemplate = (caps) => `
            總共需要剝 <span class="capsule-count">${caps}</span> 顆膠囊
            <div class="instruction">
                (75mg/顆) 溶入 <strong>50 mL</strong> 水中<br>
                每次喝 <strong>5 mL</strong>，每天兩次，共五天
            </div>
        `;

        let singleDoseMg = 0;

        if (currentMode === 'infant') {
            // 一歲以下且 > 10kg，顯示警語
            if (weight > 10) {
                resultContent.innerHTML = '<span class="warning-text">⚠️ 仿單無建議劑量</span>';
                noteDisplay.innerText = "( 未滿一歲但體重超過 10kg )";
                resultBox.style.display = 'block';
                return; 
            }
            // 正常一歲以下計算
            singleDoseMg = weight * 3;
            noteDisplay.innerText = "★ 0~12個月口服建議劑量為 3 mg/kg，每日二次，共 5 日";

        } else {
            // 一歲以上計算
            if (weight <= 15) singleDoseMg = 30;
            else if (weight <= 23) singleDoseMg = 45;
            else if (weight <= 40) singleDoseMg = 60;
            else singleDoseMg = 75;
            
            noteDisplay.innerText = "";
        }

        const totalMg = singleDoseMg * 10;
        const caps = totalMg / 75;
        const capsText = Number.isInteger(caps) ? caps : caps.toFixed(1);

        resultContent.innerHTML = standardTemplate(capsText);
        resultBox.style.display = 'block';
    }

    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./sw.js');
        });
    }
</script>

</body>
</html>
